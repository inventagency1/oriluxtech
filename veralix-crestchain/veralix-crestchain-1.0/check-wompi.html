<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n de Wompi</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>üîç Verificaci√≥n de Disponibilidad de Wompi</h1>
        
        <div id="results"></div>
        
        <button id="checkBtn" onclick="runChecks()">üöÄ Ejecutar Verificaci√≥n</button>
    </div>

    <!-- Script de Wompi -->
    <script src="https://checkout.wompi.co/widget.js" async defer></script>

    <script>
        const resultsDiv = document.getElementById('results');
        const checkBtn = document.getElementById('checkBtn');

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function checkWompiScript() {
            addResult('<div class="loading"></div> Verificando carga del script de Wompi...', 'info');
            
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 20;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (window.WidgetCheckout) {
                        clearInterval(checkInterval);
                        addResult('‚úÖ Script de Wompi cargado correctamente', 'success');
                        addResult(`üì¶ Tipo: ${typeof window.WidgetCheckout}`, 'info');
                        addResult(`üîß Constructor disponible: ${typeof window.WidgetCheckout === 'function' ? 'S√≠' : 'No'}`, 'info');
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        addResult('‚ùå Script de Wompi NO se carg√≥ despu√©s de ' + maxAttempts + ' intentos', 'error');
                        addResult('‚ö†Ô∏è Posibles causas:<br>- Bloqueador de anuncios activo<br>- Problemas de red<br>- Script bloqueado por CSP<br>- Wompi temporalmente no disponible', 'warning');
                        resolve(false);
                    }
                }, 500);
            });
        }

        async function checkWompiAPI() {
            addResult('<div class="loading"></div> Verificando API de Wompi...', 'info');
            
            try {
                const response = await fetch('https://production.wompi.co/v1/merchants/pub_prod_XHaKFhY9SF4YB3GSxBhm7o1kCxr7a1OQ', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult('‚úÖ API de Wompi responde correctamente', 'success');
                    addResult(`üìä Merchant: ${data.data?.name || 'N/A'}`, 'info');
                    addResult(`üîë Public Key v√°lida: ${data.data?.public_key ? 'S√≠' : 'No'}`, 'info');
                    
                    if (data.data?.presigned_acceptance) {
                        addResult('‚úÖ Acceptance token disponible', 'success');
                    }
                    
                    return true;
                } else {
                    addResult(`‚ùå API de Wompi respondi√≥ con error: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                addResult(`‚ùå Error al conectar con API de Wompi: ${error.message}`, 'error');
                addResult('‚ö†Ô∏è Posibles causas:<br>- Sin conexi√≥n a internet<br>- Wompi est√° ca√≠do<br>- Firewall bloqueando la conexi√≥n', 'warning');
                return false;
            }
        }

        async function checkDOMElements() {
            addResult('<div class="loading"></div> Verificando elementos DOM...', 'info');
            
            // Check for script tag
            const scriptTag = document.querySelector('script[src*="wompi"]');
            if (scriptTag) {
                addResult('‚úÖ Tag &lt;script&gt; de Wompi encontrado en el DOM', 'success');
                addResult(`üìç URL: ${scriptTag.src}`, 'info');
            } else {
                addResult('‚ùå Tag &lt;script&gt; de Wompi NO encontrado', 'error');
            }
        }

        async function checkNetworkConnectivity() {
            addResult('<div class="loading"></div> Verificando conectividad de red...', 'info');
            
            try {
                const response = await fetch('https://www.google.com', { 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                addResult('‚úÖ Conexi√≥n a internet funcionando', 'success');
                return true;
            } catch (error) {
                addResult('‚ùå Sin conexi√≥n a internet', 'error');
                return false;
            }
        }

        async function checkBrowserExtensions() {
            addResult('üîç Verificando posibles interferencias...', 'info');
            
            // Check for common ad blockers
            const adBlockerTests = [
                { name: 'AdBlock', test: () => window.adblockDetector },
                { name: 'uBlock Origin', test: () => window.uBlock },
            ];
            
            let blockersFound = false;
            adBlockerTests.forEach(({ name, test }) => {
                if (test()) {
                    addResult(`‚ö†Ô∏è Posible bloqueador detectado: ${name}`, 'warning');
                    blockersFound = true;
                }
            });
            
            if (!blockersFound) {
                addResult('‚úÖ No se detectaron bloqueadores obvios', 'success');
            } else {
                addResult('üí° Sugerencia: Desactiva bloqueadores de anuncios para checkout.wompi.co', 'warning');
            }
        }

        async function runChecks() {
            clearResults();
            checkBtn.disabled = true;
            checkBtn.textContent = '‚è≥ Ejecutando verificaci√≥n...';
            
            addResult('üöÄ Iniciando verificaci√≥n completa de Wompi...', 'info');
            addResult('‚è∞ ' + new Date().toLocaleString('es-CO'), 'info');
            
            // Run all checks
            await checkNetworkConnectivity();
            await checkDOMElements();
            await checkBrowserExtensions();
            const scriptLoaded = await checkWompiScript();
            const apiWorking = await checkWompiAPI();
            
            // Summary
            addResult('<hr>', 'info');
            if (scriptLoaded && apiWorking) {
                addResult('üéâ <strong>RESULTADO: Wompi est√° completamente funcional</strong>', 'success');
                addResult('‚úÖ Puedes proceder con las transacciones', 'success');
            } else if (!scriptLoaded && apiWorking) {
                addResult('‚ö†Ô∏è <strong>RESULTADO: API funciona pero script no carga</strong>', 'warning');
                addResult('üîß Soluci√≥n: Verifica bloqueadores de anuncios o recarga la p√°gina', 'warning');
            } else if (scriptLoaded && !apiWorking) {
                addResult('‚ö†Ô∏è <strong>RESULTADO: Script carga pero API no responde</strong>', 'warning');
                addResult('üîß Soluci√≥n: Verifica tu conexi√≥n o espera unos minutos', 'warning');
            } else {
                addResult('‚ùå <strong>RESULTADO: Wompi no est√° disponible</strong>', 'error');
                addResult('üîß Soluciones:<br>1. Verifica tu conexi√≥n a internet<br>2. Desactiva bloqueadores<br>3. Intenta en otro navegador<br>4. Contacta soporte de Wompi', 'error');
            }
            
            checkBtn.disabled = false;
            checkBtn.textContent = 'üîÑ Ejecutar Nueva Verificaci√≥n';
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(runChecks, 1000);
        });
    </script>
</body>
</html>
